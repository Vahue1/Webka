<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>LagSw — Admin Console</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.5;background:var(--bg);color:var(--fg)}
    :root{--bg:#0b0f14;--panel:#121825;--elev:rgba(255,255,255,.06);--fg:#e6eaf0;--muted:#97a2b5;--acc:#7aa2ff;--ok:#7bd88f;--err:#ff6b6b;--warn:#ffb86b;--bd:rgba(255,255,255,.14);--shadow:0 8px 28px rgba(0,0,0,.35);--r:14px}
    @media (prefers-color-scheme: light){:root{--bg:#f6f8fb;--panel:#ffffff;--elev:rgba(0,0,0,.02);--fg:#0f172a;--muted:#475569;--acc:#2b6cff;--ok:#059669;--err:#dc2626;--warn:#b7791f;--bd:rgba(0,0,0,.12);--shadow:0 8px 22px rgba(0,0,0,.12)}}
    header{position:sticky;top:0;background:linear-gradient(180deg,var(--panel),transparent);border-bottom:1px solid var(--bd);backdrop-filter:blur(8px);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .hline{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--acc),var(--ok));display:grid;place-items:center}
    .brand h1{font-size:1.05rem;margin:0}
    nav{display:flex;gap:10px}
    .tab{appearance:none;border:1px solid var(--bd);background:var(--panel);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--acc);color:#fff;border-color:transparent}
    main{max-width:1100px;margin:18px auto;padding:0 18px;display:grid;gap:18px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--elev));border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 280px}
    .muted{color:var(--muted)}
    .input, textarea, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--bd);background:rgba(0,0,0,.06);color:var(--fg)}
    @media (prefers-color-scheme: light){.input,textarea,select{background:#fff}}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:700;background:var(--acc);color:#fff;cursor:pointer}
    .btn.alt{background:transparent;color:var(--fg);border:1px solid var(--bd)}
    .btn.danger{background:var(--err)}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 12px;text-align:left}
    tbody tr{background:linear-gradient(180deg,var(--panel),var(--elev));border:1px solid var(--bd)}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.85rem}
    .pill.ok{background:color-mix(in oklab,var(--ok) 22%, transparent);color:var(--ok);border:1px solid color-mix(in oklab,var(--ok) 55%, transparent)}
    .pill.err{background:color-mix(in oklab,var(--err) 18%, transparent);color:var(--err);border:1px solid color-mix(in oklab,var(--err) 50%, transparent)}
    .pill.warn{background:color-mix(in oklab,var(--warn) 18%, transparent);color:var(--warn);border:1px solid color-mix(in oklab,var(--warn) 45%, transparent)}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .right{margin-left:auto}
    .toast{position:fixed;right:16px;bottom:16px;z-index:50}
    .toast .msg{margin-top:10px;padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:var(--panel);box-shadow:var(--shadow)}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
<header>
  <div class="wrap hline">
    <div class="brand">
      <div class="logo" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 2l7 3v6c0 5-3.5 9-7 11-3.5-2-7-6-7-11V5l7-3z" stroke="white" opacity="0.9" stroke-width="1.4"/></svg></div>
      <h1>LagSw — Admin Console</h1>
      <span class="muted">Keys & Downloads</span>
    </div>
    <nav>
      <button class="tab" id="tab-keys" aria-selected="true">Keys</button>
      <button class="tab" id="tab-files" aria-selected="false">Downloads</button>
      <button class="tab" id="tab-config" aria-selected="false">Config</button>
    </nav>
  </div>
</header>

<main>
  <section id="view-keys" class="panel">
    <div class="grid cols-2">
      <div class="grid">
        <h3>Add Keys</h3>
        <textarea id="keys-input" rows="6" placeholder="One key per line"></textarea>
        <div class="row">
          <div class="grow">
            <label class="muted" for="duration-days">Duration (days, optional)</label>
            <input id="duration-days" class="input" type="number" min="1" step="1" placeholder="e.g. 30" />
          </div>
          <div style="align-self:end">
            <button id="btn-add-keys" class="btn">Add</button>
          </div>
        </div>
      </div>
      <div class="grid">
        <h3>Search</h3>
        <input id="search" class="input" placeholder="Filter by key substring" />
        <div class="muted">Keys are normalized to A–Z/0–9 on the server.</div>
      </div>
    </div>

    <h3 style="margin-top:14px">Keys</h3>
    <div class="muted" id="keys-summary">Loading…</div>
    <div style="overflow:auto">
      <table id="keys-table">
        <thead>
          <tr>
            <th>Key</th>
            <th>Duration</th>
            <th>Activated</th>
            <th>Expires</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="view-files" class="panel" hidden>
    <div class="row">
      <div class="grow">
        <h3>Upload</h3>
        <input id="file-input" class="input" type="file" />
      </div>
      <div style="align-self:end"><button id="btn-upload" class="btn">Upload</button></div>
    </div>

    <h3 style="margin-top:14px">Files</h3>
    <div class="muted" id="files-summary">Loading…</div>
    <div style="overflow:auto">
      <table id="files-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Size</th>
            <th>Modified</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="view-config" class="panel" hidden>
    <h3>Success Download Behavior</h3>
    <div class="row">
      <div class="grow">
        <label class="muted" for="default-file">Default file (served as <span class="code">file</span> in API response)</label>
        <select id="default-file" class="input"></select>
      </div>
      <div style="align-self:end"><button id="btn-save-config" class="btn">Save</button></div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
"use strict";
// Admin API prefix
const API = {
  keys: "/admin-api/keys",
  files: "/admin-api/files",
  config: "/admin-api/config"
};

function fmtBytes(b){
  const u=["B","KB","MB","GB","TB"]; let i=0, x=b;
  while(x>=1024&&i<u.length-1){x/=1024;i++}
  return `${x.toFixed(x>=10||i===0?0:1)} ${u[i]}`;
}
function fmtDate(ts){ if(!ts) return "—"; const d=new Date(ts*1000); return d.toISOString().replace('T',' ').slice(0,19); }
function toast(msg){ const t=document.getElementById('toast'); const n=document.createElement('div'); n.className='msg'; n.textContent=msg; t.appendChild(n); setTimeout(()=>n.remove(),3500); }
function mask(s){ return s.replace(/(.{4})(?=.)/g,"$1-"); }

async function fetchJSON(url, opts){
  const r = await fetch(url, Object.assign({headers:{"Accept":"application/json"}}, opts||{}));
  if(r.status===401){ toast("Unauthorized. Reload and enter admin credentials."); throw new Error("401"); }
  if(r.headers.get("content-type")?.includes("application/json")){
    const j = await r.json(); if(!r.ok) throw new Error(j.message||"Error"); return j;
  } else { const tx = await r.text(); if(!r.ok) throw new Error(tx||"Error"); return tx; }
}

// Tabs
const views = { keys: document.getElementById('view-keys'), files: document.getElementById('view-files'), config: document.getElementById('view-config') };
function sel(tab){ for(const [k,el] of Object.entries(views)){ const b=document.getElementById('tab-'+k); const on=(k===tab); el.hidden=!on; b.setAttribute('aria-selected', String(on)); } }

document.getElementById('tab-keys').onclick=()=>sel('keys');
document.getElementById('tab-files').onclick=()=>{ sel('files'); loadFiles(); };
document.getElementById('tab-config').onclick=()=>{ sel('config'); loadConfig(); };

// Keys view
async function loadKeys(){
  const q = document.getElementById('search').value.trim();
  const url = q? `${API.keys}?q=${encodeURIComponent(q)}` : API.keys;
  const data = await fetchJSON(url);
  const tb = document.querySelector('#keys-table tbody'); tb.innerHTML='';
  data.items.forEach(it=>{
    const tr=document.createElement('tr');
    const status = it.isExpired? '<span class="pill err">Expired</span>' : (it.firstActivatedAt? '<span class="pill ok">Active</span>' : '<span class="pill warn">Unused</span>');
    tr.innerHTML = `
      <td class="code">${mask(it.keyNorm)}</td>
      <td>${it.durationDays??'—'}</td>
      <td>${fmtDate(it.firstActivatedAt)}</td>
      <td>${fmtDate(it.expiresAt)}</td>
      <td>${status}</td>
      <td>
        <button class="btn alt" data-act="setdur" data-key="${it.keyNorm}">Set duration</button>
        <button class="btn alt" data-act="reset" data-key="${it.keyNorm}">Reset activation</button>
        <button class="btn danger" data-act="del" data-key="${it.keyNorm}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  document.getElementById('keys-summary').textContent = `${data.total} total, showing ${data.items.length}`;
}

document.getElementById('btn-add-keys').onclick=async()=>{
  const text=document.getElementById('keys-input').value.trim(); if(!text){toast('Nothing to add');return}
  const dur=document.getElementById('duration-days').value; const durationDays = dur? Number(dur): null;
  const keys = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  try{
    const res=await fetchJSON(API.keys,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({keys,durationDays})});
    toast(`Inserted: ${res.inserted}, skipped: ${res.skipped}`); document.getElementById('keys-input').value=''; loadKeys();
  }catch(e){toast(String(e))}
};

document.getElementById('keys-table').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return; const key=b.getAttribute('data-key'); const act=b.getAttribute('data-act');
  try{
    if(act==='del'){
      if(!confirm('Delete this key?')) return;
      await fetchJSON(`${API.keys}/${key}`,{method:'DELETE'}); toast('Deleted'); loadKeys();
    } else if(act==='reset'){
      await fetchJSON(`${API.keys}/${key}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({resetActivation:true})});
      toast('Activation reset'); loadKeys();
    } else if(act==='setdur'){
      const v = prompt('Duration in days (empty to unset):');
      const body = (v && v.trim().length) ? {durationDays:Number(v)} : {durationDays:null};
      await fetchJSON(`${API.keys}/${key}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      toast('Duration updated'); loadKeys();
    }
  }catch(err){toast(String(err))}
});

// Files view
async function loadFiles(){
  const data = await fetchJSON(API.files);
  const tb=document.querySelector('#files-table tbody'); tb.innerHTML='';
  data.items.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="code">${it.name}</td><td>${fmtBytes(it.size)}</td><td>${new Date(it.mtime*1000).toLocaleString()}</td>
      <td><button class="btn danger" data-act="del" data-name="${it.name}">Delete</button></td>`;
    tb.appendChild(tr);
  });
  document.getElementById('files-summary').textContent = `${data.items.length} files`;
  // fill config select
  const sel = document.getElementById('default-file'); sel.innerHTML='<option value="">— none —</option>';
  data.items.forEach(it=>{ const o=document.createElement('option'); o.value=it.name; o.textContent=it.name; sel.appendChild(o); });
}

document.getElementById('files-table').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return; const name=b.getAttribute('data-name');
  if(!confirm(`Delete ${name}?`)) return;
  try{ await fetchJSON(`${API.files}/${encodeURIComponent(name)}`,{method:'DELETE'}); toast('File deleted'); loadFiles(); }catch(err){toast(String(err))}
});

document.getElementById('btn-upload').onclick=async()=>{
  const fi=document.getElementById('file-input'); if(!fi.files.length){toast('Pick a file');return}
  const fd=new FormData(); fd.append('file', fi.files[0]);
  try{ await fetchJSON(API.files,{method:'POST',body:fd}); toast('Uploaded'); fi.value=''; loadFiles(); }catch(err){toast(String(err))}
};

// Config
async function loadConfig(){
  const cfg = await fetchJSON(API.config);
  const sel=document.getElementById('default-file'); if(cfg.defaultDownloadFile){ sel.value = cfg.defaultDownloadFile; }
}

document.getElementById('btn-save-config').onclick=async()=>{
  const v=document.getElementById('default-file').value || null;
  try{ await fetchJSON(API.config,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({defaultDownloadFile:v})}); toast('Saved'); }catch(err){toast(String(err))}
};

// init
(async function(){ sel('keys'); try{ await loadKeys(); }catch(e){ console.error(e); }
  try{ await fetchJSON('/healthz'); }catch(_){ /* ignore */ }
})();
</script>
</body>
</html>
